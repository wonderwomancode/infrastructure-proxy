# Caddy SSL Proxy with DNS-01 Let's Encrypt
#
# Uses Cloudflare DNS API for certificate provisioning.
# This allows automatic SSL for custom domains on Akash Network
# where HTTP-01 challenges don't work due to ingress interception.
#
# Required environment variable:
#   CF_API_TOKEN - Cloudflare API token with Zone:DNS:Edit permission

{
    # Email for Let's Encrypt notifications
    email admin@alternatefutures.ai

    # Uncomment for testing with Let's Encrypt staging
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory

    # Admin API (internal)
    admin 0.0.0.0:2019
}

# Auth Service
auth.alternatefutures.ai {
    # DNS-01 challenge via Cloudflare
    tls {
        dns cloudflare {env.CF_API_TOKEN}
    }

    reverse_proxy {$AUTH_BACKEND:auth-api:3000}

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        -Server
    }

    log {
        output stdout
        format json
    }
}

# API Service
api.alternatefutures.ai {
    tls {
        dns cloudflare {env.CF_API_TOKEN}
    }

    reverse_proxy {$API_BACKEND:api-service:4000}

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        -Server
    }

    log {
        output stdout
        format json
    }
}

# App (Web Dashboard)
app.alternatefutures.ai {
    tls {
        dns cloudflare {env.CF_API_TOKEN}
    }

    reverse_proxy {$APP_BACKEND:web-app:3000}

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        -Server
    }

    log {
        output stdout
        format json
    }
}

# Health check endpoint (HTTP only, no TLS)
:8080 {
    respond /health "OK" 200
    respond / "AlternateFutures SSL Proxy" 200
}
