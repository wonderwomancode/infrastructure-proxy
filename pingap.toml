# Pingap Configuration - SSL Proxy for AlternateFutures
# Built on Cloudflare's Pingora framework
#
# Uses Cloudflare Origin Certificate (static) instead of ACME DNS-01
# This avoids DNS propagation timing issues with Let's Encrypt

[basic]
name = "alternatefutures-proxy"
threads = 2
work_stealing = true
grace_period = "10s"
pid_file = "/tmp/pingap.pid"

# Static Certificate from Cloudflare Origin CA
# Files are written by entrypoint.sh from environment variables
# Use 'cert' and 'key' for file paths (not 'tls_cert' and 'tls_key')
[certificates.alternatefutures]
cert = "/etc/pingap/certs/origin.crt"
key = "/etc/pingap/certs/origin.key"

# Auth Service Backend
[upstreams.auth]
addrs = ["ubsm31q4ol97b1pi5l06iognug.ingress.europlots.com:443"]
sni = "ubsm31q4ol97b1pi5l06iognug.ingress.europlots.com"
connection_timeout = "10s"

# API Service Backend
[upstreams.api]
addrs = ["cjrdmusuql9e34bevi8mjgj8pg.ingress.europlots.com:443"]
sni = "cjrdmusuql9e34bevi8mjgj8pg.ingress.europlots.com"
connection_timeout = "10s"

# IPFS Gateway Backend (for static sites)
[upstreams.ipfs]
addrs = ["provider.europlots.com:32160"]
connection_timeout = "30s"

# Secrets (Infisical) Backend
[upstreams.secrets]
addrs = ["pf3ca74njl8ch8ta1qiocss0a0.ingress.europlots.com:443"]
sni = "pf3ca74njl8ch8ta1qiocss0a0.ingress.europlots.com"
connection_timeout = "10s"

# Route: Auth Service
[locations.auth]
upstream = "auth"
host = "auth.alternatefutures.ai"
path = "/"
proxy_set_headers = ["X-Forwarded-Proto: https", "X-Real-IP: $remote_addr"]

# Route: API Service
[locations.api]
upstream = "api"
host = "api.alternatefutures.ai"
path = "/"
proxy_set_headers = ["X-Forwarded-Proto: https", "X-Real-IP: $remote_addr"]

# Route: Main Website (IPFS-hosted web-app)
[locations.website]
upstream = "ipfs"
host = "alternatefutures.ai"
path = "/"
rewrite = "^(.*)$ /ipfs/QmU4VRKexpuA6RvYfXY9nUsgiHRMLDhxvZFi7ssGHn3aHj$1"
proxy_set_headers = ["X-Forwarded-Proto: https", "X-Real-IP: $remote_addr"]

# Route: Documentation (IPFS-hosted docs)
[locations.docs]
upstream = "ipfs"
host = "docs.alternatefutures.ai"
path = "/"
rewrite = "^(.*)$ /ipfs/QmeQe1QuyiAiyCrJLASixPtH2VW6xQZxcpqCHJsUTtxfUR$1"
proxy_set_headers = ["X-Forwarded-Proto: https", "X-Real-IP: $remote_addr"]

# Route: App Dashboard (IPFS-hosted web-app)
[locations.app]
upstream = "ipfs"
host = "app.alternatefutures.ai"
path = "/"
rewrite = "^(.*)$ /ipfs/QmU4VRKexpuA6RvYfXY9nUsgiHRMLDhxvZFi7ssGHn3aHj$1"
proxy_set_headers = ["X-Forwarded-Proto: https", "X-Real-IP: $remote_addr"]

# Route: Secrets (Infisical)
[locations.secrets]
upstream = "secrets"
host = "secrets.alternatefutures.ai"
path = "/"
proxy_set_headers = ["X-Forwarded-Proto: https", "X-Real-IP: $remote_addr"]

# Health check route
[locations.health]
path = "/health"
plugins = ["pingap:responseHeaders?X-Health-Check:ok", "pingap:mock?status=200&text=OK"]

# HTTPS Server - with static TLS certificate
[servers.https]
addr = "0.0.0.0:443"
locations = ["auth", "api", "website", "docs", "app", "secrets"]
tls = "alternatefutures"
tls_cipher_list = "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384"
tls_min_version = "1.2"
enabled_h2 = true

# Health check HTTP Server
[servers.health]
addr = "0.0.0.0:8080"
locations = ["health"]
