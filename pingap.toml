# Pingap Configuration - SSL Proxy for AlternateFutures
# Built on Cloudflare's Pingora framework

[basic]
name = "alternatefutures-proxy"
threads = 2
work_stealing = true
grace_period = "10s"
pid_file = "/tmp/pingap.pid"

# Certificate with DNS-01 via Cloudflare
[certificates.alternatefutures]
domains = "auth.alternatefutures.ai,api.alternatefutures.ai,app.alternatefutures.ai"
acme = "lets_encrypt"
dns_challenge = true
dns_provider = "cloudflare"
dns_service_url = "$PINGAP_DNS_SERVICE_URL"
buffer_days = 30

# Auth Service Backend
[upstreams.auth]
addrs = ["ubsm31q4ol97b1pi5l06iognug.ingress.europlots.com:443"]
sni = "ubsm31q4ol97b1pi5l06iognug.ingress.europlots.com"
connection_timeout = "10s"

# API Service Backend
[upstreams.api]
addrs = ["cjrdmusuql9e34bevi8mjgj8pg.ingress.europlots.com:443"]
sni = "cjrdmusuql9e34bevi8mjgj8pg.ingress.europlots.com"
connection_timeout = "10s"

# App Backend (placeholder)
[upstreams.app]
addrs = ["app.ingress.europlots.com:443"]
sni = "app.ingress.europlots.com"
connection_timeout = "10s"

# Route: Auth Service
[locations.auth]
upstream = "auth"
host = "auth.alternatefutures.ai"
path = "/"
proxy_set_headers = ["X-Forwarded-Proto: https", "X-Real-IP: $remote_addr"]

# Route: API Service
[locations.api]
upstream = "api"
host = "api.alternatefutures.ai"
path = "/"
proxy_set_headers = ["X-Forwarded-Proto: https", "X-Real-IP: $remote_addr"]

# Route: App Service
[locations.app]
upstream = "app"
host = "app.alternatefutures.ai"
path = "/"
proxy_set_headers = ["X-Forwarded-Proto: https", "X-Real-IP: $remote_addr"]

# Health check route
[locations.health]
path = "/health"
plugins = ["pingap:responseHeaders?X-Health-Check:ok", "pingap:mock?status=200&text=OK"]

# HTTPS Server
[servers.https]
addr = "0.0.0.0:443"
locations = ["auth", "api", "app"]
tls_cipher_list = "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384"
tls_min_version = "1.2"
enabled_h2 = true

# Health check HTTP Server
[servers.health]
addr = "0.0.0.0:8080"
locations = ["health"]
