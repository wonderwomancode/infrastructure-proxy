# Pingap Configuration - SSL Proxy for AlternateFutures
# Built on Cloudflare's Pingora framework
#
# Uses Cloudflare Origin Certificate (static) instead of ACME DNS-01
# This avoids DNS propagation timing issues with Let's Encrypt

[basic]
name = "alternatefutures-proxy"
threads = 2
work_stealing = true
grace_period = "10s"
pid_file = "/tmp/pingap.pid"

# Static Certificate from Cloudflare Origin CA
# Files are written by entrypoint.sh from environment variables
# Use 'cert' and 'key' for file paths (not 'tls_cert' and 'tls_key')
[certificates.alternatefutures]
cert = "/etc/pingap/certs/origin.crt"
key = "/etc/pingap/certs/origin.key"

# Auth Service Backend
[upstreams.auth]
addrs = ["ubsm31q4ol97b1pi5l06iognug.ingress.europlots.com:443"]
sni = "ubsm31q4ol97b1pi5l06iognug.ingress.europlots.com"
connection_timeout = "10s"
health_check_connection_timeout = "10s"
verify_cert = false

# API Service Backend
[upstreams.api]
addrs = ["rvknp4kjg598n8uslgnovkrdpk.ingress.gpu.subangle.com:443"]
sni = "rvknp4kjg598n8uslgnovkrdpk.ingress.gpu.subangle.com"
connection_timeout = "10s"
health_check_connection_timeout = "10s"
verify_cert = false

# IPFS Gateway Backend (for static sites)
[upstreams.ipfs]
addrs = ["provider.europlots.com:32160"]
connection_timeout = "30s"
health_check_connection_timeout = "10s"

# Secrets (Infisical) Backend
[upstreams.secrets]
addrs = ["v8c1fui9p1dah5m86ctithi5ok.ingress.europlots.com:443"]
sni = "v8c1fui9p1dah5m86ctithi5ok.ingress.europlots.com"
connection_timeout = "10s"
health_check_connection_timeout = "10s"
verify_cert = false

# Route: Auth Service
[locations.auth]
upstream = "auth"
host = "auth.alternatefutures.ai"
path = "/"
proxy_set_headers = ["Host: ubsm31q4ol97b1pi5l06iognug.ingress.europlots.com", "X-Forwarded-Proto: https", "X-Forwarded-Host: auth.alternatefutures.ai", "X-Real-IP: $remote_addr"]

# Route: API Service
[locations.api]
upstream = "api"
host = "api.alternatefutures.ai"
path = "/"
proxy_set_headers = ["Host: rvknp4kjg598n8uslgnovkrdpk.ingress.gpu.subangle.com", "X-Forwarded-Proto: https", "X-Forwarded-Host: api.alternatefutures.ai", "X-Real-IP: $remote_addr"]

# Route: Main Website (IPFS-hosted web-app)
[locations.website]
upstream = "ipfs"
host = "alternatefutures.ai"
path = "/"
rewrite = "^(.*)$ /ipfs/QmU4VRKexpuA6RvYfXY9nUsgiHRMLDhxvZFi7ssGHn3aHj$1"
proxy_set_headers = ["X-Forwarded-Proto: https", "X-Real-IP: $remote_addr"]

# Route: Documentation (IPFS-hosted docs)
[locations.docs]
upstream = "ipfs"
host = "docs.alternatefutures.ai"
path = "/"
rewrite = "^(.*)$ /ipfs/QmeQe1QuyiAiyCrJLASixPtH2VW6xQZxcpqCHJsUTtxfUR$1"
proxy_set_headers = ["X-Forwarded-Proto: https", "X-Real-IP: $remote_addr"]

# Route: App Dashboard (IPFS-hosted web-app)
[locations.app]
upstream = "ipfs"
host = "app.alternatefutures.ai"
path = "/"
rewrite = "^(.*)$ /ipfs/QmU4VRKexpuA6RvYfXY9nUsgiHRMLDhxvZFi7ssGHn3aHj$1"
proxy_set_headers = ["X-Forwarded-Proto: https", "X-Real-IP: $remote_addr"]

# Route: Secrets (Infisical)
[locations.secrets]
upstream = "secrets"
host = "secrets.alternatefutures.ai"
path = "/"
proxy_set_headers = ["Host: v8c1fui9p1dah5m86ctithi5ok.ingress.europlots.com", "X-Forwarded-Proto: https", "X-Forwarded-Host: secrets.alternatefutures.ai", "X-Real-IP: $remote_addr"]

# Health check route
[locations.health]
path = "/health"
plugins = ["pingap:responseHeaders?X-Health-Check:ok", "pingap:mock?status=200&text=OK"]

# HTTP Server (for Akash ingress - Cloudflare handles TLS at edge)
[servers.http]
addr = "0.0.0.0:80"
locations = ["auth", "api", "website", "docs", "app", "secrets", "health"]

# HTTPS Server - with static TLS certificate (optional, for direct TLS)
[servers.https]
addr = "0.0.0.0:443"
locations = ["auth", "api", "website", "docs", "app", "secrets"]
tls = "alternatefutures"
tls_cipher_list = "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384"
tls_min_version = "1.2"
enabled_h2 = true

# Health check HTTP Server (for Akash health probes)
[servers.health]
addr = "0.0.0.0:8080"
locations = ["health"]
